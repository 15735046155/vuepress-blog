<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>快乐的小废物</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/vuepress-blog/logo.png">
    <meta name="description" content="Welcome to my blog">
    
    <link rel="preload" href="/vuepress-blog/assets/css/0.styles.a53365af.css" as="style"><link rel="preload" href="/vuepress-blog/assets/js/app.355d11a0.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/2.9d76f0cb.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/6.762efb8c.js" as="script"><link rel="prefetch" href="/vuepress-blog/assets/js/10.aac0aeba.js"><link rel="prefetch" href="/vuepress-blog/assets/js/11.4c4efc84.js"><link rel="prefetch" href="/vuepress-blog/assets/js/12.26074c91.js"><link rel="prefetch" href="/vuepress-blog/assets/js/3.2fb6b42a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/4.7a545b19.js"><link rel="prefetch" href="/vuepress-blog/assets/js/5.d45e1e33.js"><link rel="prefetch" href="/vuepress-blog/assets/js/7.d3c53519.js"><link rel="prefetch" href="/vuepress-blog/assets/js/8.56e2ef99.js"><link rel="prefetch" href="/vuepress-blog/assets/js/9.971357ab.js">
    <link rel="stylesheet" href="/vuepress-blog/assets/css/0.styles.a53365af.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress-blog/" class="home-link router-link-active"><img src="/vuepress-blog/logo.png" alt="快乐的小废物" class="logo"> <span class="site-name can-hide">快乐的小废物</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/vuepress-blog/js-gj/this.html" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/vuepress-blog/day/202204-01.html" class="nav-link">
  日常
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vuepress-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/vuepress-blog/js-gj/this.html" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/vuepress-blog/day/202204-01.html" class="nav-link">
  日常
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>js-高级</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>记录日常</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-blog/day/202205-01.html" aria-current="page" class="active sidebar-link">202205</a></li><li><a href="/vuepress-blog/day/202204-01.html" class="sidebar-link">202204</a></li><li><a href="/vuepress-blog/day/202203-01.html" class="sidebar-link">202203</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><blockquote><p>1.本月迭代收到一个证书的需求，要求可以下载，格式为pdf</p></blockquote> <blockquote><p>2.思路：把dom转为图片，上传到七牛，然后在转为pdf</p></blockquote> <blockquote><p>3.主要使用的技术：html2canvas、jspdf</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 1.生成图片前需要把html的宽度放大一些，这样html2canvas才会清晰，</span>
<span class="token comment">//   重点： 第8、11、12、15行，生成完成后再把布局缩小回去，因为我的页面要展示布局。</span>
<span class="token comment">// 2.图片转pdf时，设置画布大小一级图片大小</span>
   
<span class="token comment">// html转为图片（base64格式），且上传到七牛</span>

<span class="token keyword">async</span> <span class="token function">sureMade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token keyword">const</span> targetDom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#certificate_box'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// dom布局</span>
  targetDom<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform <span class="token operator">=</span> <span class="token string">'scale(3, 3)'</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token function">html2canvas</span><span class="token punctuation">(</span>targetDom<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">width</span><span class="token operator">:</span> targetDom<span class="token punctuation">.</span>scrollWidth <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token literal-property property">height</span><span class="token operator">:</span> targetDom<span class="token punctuation">.</span>scrollHeight <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token literal-property property">useCORS</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">canvas</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    targetDom<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform <span class="token operator">=</span> <span class="token string">'scale(1,1)'</span>
    <span class="token keyword">const</span> pageData <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token string">'image/jpeg'</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生成的是base64格式</span>
    <span class="token comment">//注意这个url,可以指定key(文件名), mimeType(文件类型)</span>
    <span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">&quot;http://up.qiniu.com/putb64/-1&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/octet-stream&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">UpToken </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>你的token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>pageData<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xhr<span class="token punctuation">.</span><span class="token function-variable function">onloadend</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span>status<span class="token punctuation">,</span> responseText<span class="token punctuation">}</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>currentTarget
      <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>responseText<span class="token punctuation">)</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>你的域名<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>上传七牛成功后会返回的key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">madeCertificate</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token comment">// 掉接口保存到数据库</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>$message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'生成失败'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// 图片转pdf</span>
<span class="token function">download</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> loading <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$loading</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">lock</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">spinner</span><span class="token operator">:</span> <span class="token string">'el-icon-loading'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">background</span><span class="token operator">:</span> <span class="token string">'rgba(0, 0, 0, 0.7)'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 加loading，防止多次点击</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> img <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>refImg <span class="token comment">// 获取图片</span>
    <span class="token comment">// pdf的参数：pdf方向(横向，竖向), pdf大小单位，  pdf的宽，高  </span>
    <span class="token keyword">const</span> <span class="token constant">PDF</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>jspdf<span class="token punctuation">.</span>default</span><span class="token punctuation">(</span><span class="token string">'l'</span><span class="token punctuation">,</span> <span class="token string">'px'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>img<span class="token punctuation">.</span>width <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">,</span>img<span class="token punctuation">.</span>height <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 生成时参数：图片url(eg:https://restest.17win.com/Fio65gL1LV3FVcva4uJ2rCmisHzh),图片格式，间距（相当于padding 上下，左右），生成时pdf中图片宽度，生成时pdf中图片图片高度</span>
    <span class="token constant">PDF</span><span class="token punctuation">.</span><span class="token function">addImage</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token string">'JPEG'</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> img<span class="token punctuation">.</span>width<span class="token punctuation">,</span> img<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 启用promise,完成后关闭loading</span>
    <span class="token constant">PDF</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pdf的文档名称<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.pdf</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">returnPromise</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      loading<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><p>效果如下图：</p> <p><img src="/vuepress-blog/assets/img/certificate.35f3aa67.png" alt="证书效果图"></p> <p>其中遇到的问题：</p> <p>问题一： 产出图片比较糊，于是从png换成了svg,但是还是糊，
原因：证书的底部图案我的原始布局是用背景图实现的，所以生成的背景图一直很糊
解决方案：换成img标签定位实现，以及生成的时候放大原先布局</p> <p>问题二：生成的pdf中图片只有一部分（不是整张图）
原因：在new pdf的时候画布的单位、大小设置问题，但是在mac是完整的，window上就只有部分
解决方案：设置pdf的单位为px,且设置画布大小一定要大于等于图片大小。设置生成时的图片大小以及边距问题。</p> <p>问题三：证书上用户头像上传七牛，https与http的问题。
原因：非生产环境的协议是http，生产是https, http调用https的没有问题，但是https调用http的就会产生问题
<code>const uploadUrl = window.location.protocol === 'https:' ? 'https://up.qbox.me' : 'http://upload.qiniu.com'</code>
解决方案：可以直接使用 <code>https://up.qbox.me</code></p> <p>问题四：证书名称是路由上获取的，当证书名称中有%的话，报错（URIError: URI malformed）
原因：浏览器会对地址栏中的路径进行自动解码，所以在页面中拿到就是%，但是在decodeURIComponent解码的时候需要吧%处理为%25才可以正常解码。
解决方案：在传入的时候几直接进行编码<code>${encodeURIComponent(title)}</code>,直接使用，浏览器会帮你解码</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vuepress-blog/js-gj/call-apply-bind.html" class="prev">
        手写call-apply-bind
      </a></span> <span class="next"><a href="/vuepress-blog/day/202204-01.html">
        202204
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/vuepress-blog/assets/js/app.355d11a0.js" defer></script><script src="/vuepress-blog/assets/js/2.9d76f0cb.js" defer></script><script src="/vuepress-blog/assets/js/6.762efb8c.js" defer></script>
  </body>
</html>
